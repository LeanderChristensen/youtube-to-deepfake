<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Youtube to deepfake</title>
    <link rel="icon" type="image/x-icon" href="Snorre_2.ico">
    <link href="index.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        var voice_id = null;
        const socket = io.connect();
        socket.on('progress', function(percentage) {
            $('#progressBar').width(percentage + '%');
        });
		setInterval(() => {
			if (voice_id) {
				Promise.race([
				  fetch(`/checkSessionExpired/${voice_id}`),
				  new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 15000))
				])
				  .then(res => res.json())
				  .then(data => {
				    if (data.sessionExpired) {
				      document.getElementById('linkFormDiv').style.display = 'block';
				      document.getElementById('ttsFormDiv').style.display = 'none';
				      document.getElementById('loadingDiv').style.display = 'none';
				      document.getElementById('errorDiv').style.display = 'none';
				    }
				  })
				  .catch(error => {
				    console.error(error);
				    document.getElementById('linkFormDiv').style.display = 'none';
				    document.getElementById('ttsFormDiv').style.display = 'none';
				    document.getElementById('loadingDiv').style.display = 'none';
				    document.getElementById('errorDiv').style.display = 'block';
				  });
			}
		}, 10000); // check server/client connection every 10 seconds
        function linkSubmit(e){
            document.getElementById('linkFormDiv').style.display = 'none';
            document.getElementById('loadingDiv').style.display = 'block';
            e.preventDefault(); //This will prevent the default click action
            $.ajax({
                type: $('#linkForm').attr('method'),
                url: '/download',
                data: $('#linkForm').serialize(),
                success: function (data) {
                    console.log('Submission was successful.');
                    voice_id = data.voice_id;
                    console.log(`voice_id: ${voice_id}`);
                    document.getElementById('loadingDiv').style.display = 'none';
                    document.getElementById('ttsFormDiv').style.display = 'block';
                },
                error: function (data) {
                    console.log('An error occurred.');
                }
            });
        }
        function ttsSubmit(e){
            e.preventDefault(); //This will prevent the default click action
            $.ajax({
                type: $('#ttsForm').attr('method'),
                url: '/tts',
                data: $('#ttsForm').serialize() + '&voice_id=' + voice_id,
                success: function (data) {
                    console.log('Submission was successful.');
                    const base64Audio = data;

                    // Convert the base64 encoded string to an ArrayBuffer
                    const binaryString = window.atob(base64Audio);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                      bytes[i] = binaryString.charCodeAt(i);
                    }

                    const audioBlob = new Blob([bytes.buffer], { type: 'audio/mpeg' });
                    const audioURL = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioURL);
                    audio.play();
                },
                error: function (data) {
                    console.log('An error occurred.');
                    console.log(data);
                }
            });
        }
    </script>
</head>
<body>
<div id="main">
    <h1>Youtube to deepfake voice app</h1>
    <div id="linkFormDiv">
        <form action="#" id="linkForm" onsubmit="linkSubmit(event);" method="POST">
            <input class="form-control textBox" id="youtube-link" name="url" type="text" value="https://www.youtube.com/watch?v=KMU0tzLwhbE" placeholder="https://www.youtube.com/watch?v=2ZIpFytCSVc">
            <input class="btn btn-outline-light formButton" type="submit" value="Submit link">
        </form>
    </div>
    <div id="loadingDiv" style="display: none;">
        <h2>Loading</h2>
        <div id="progressBar" style="height:50px;background-color:blue;"></div>
    </div>
    <div id="ttsFormDiv" style="display:block;">
        <form action="#" id="ttsForm" onsubmit="ttsSubmit(event);" method="POST">
            <textarea class="form-control textBox" id="voice" name="text" rows="4" cols="50"></textarea>
            <input id="submitBtn" class="btn btn-outline-light formButton" type="submit">
            <input id="playBtn" class="btn btn-outline-light formButton" type="submit" value="Play" disabled>
            <input id="downloadBtn" class="btn btn-outline-light formButton" type="submit" value="Download" disabled>
        </form>
    </div>
</div>
</body>
</html>